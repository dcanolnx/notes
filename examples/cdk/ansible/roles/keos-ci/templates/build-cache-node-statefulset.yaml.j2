apiVersion: v1
kind: StatefulSet
metadata:
  name: build-cache-node
  namespace: "{{ jenkins_namespace }}"
  labels:
    app: gradle-enterprise
    component: build-cache-node
spec:
  selector:
    matchLabels:
      app: gradle-enterprise
      component: build-cache-node
  serviceName: build-cache-node
  template:
    metadata:
      labels:
        app: gradle-enterprise
        component: build-cache-node
    spec:
      initContainers:
      - name: config-mounter
        image: "busybox:1.33.0"
        command: 
          - "/bin/sh"
          - "-c"
          - "cp /secret/config.yaml /data/conf/config.yaml"
        volumeMounts:
          - name: apikey-config-volume
            mountPath: /secret
            readOnly: true
          - name: build-cache-config-dir
            mountPath: /data/conf
      containers:
      - name: build-cache-node
        image: "gradle/build-cache-node:12.2"
        args: [ "start" ]
        ports:
        - containerPort: 5071
        resources:
          requests:
            memory: 1Gi
            cpu: 0.5
          limits:
            memory: 2Gi
            cpu: 1.5
        env:
        - name: EXCLUSIVE_VOLUME_SIZE
          value: "10Gi"
        volumeMounts:
          - name:  build-cache-config-dir
            mountPath: /data/conf 
      volumes:
        - name: build-cache-config-dir
          emptyDir: {}
        - name: apikey-config-volume
          secret:
           secretName: gradle-build-cache-config-secret

  volumeClaimTemplates:
  - metadata:
      name: build-cache-node-data-volume
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: '10Gi'
      storageClassName: 'pure-block'
